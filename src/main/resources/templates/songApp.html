<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" http-equiv="Content-Type" content="text/html" />
        <title>ういのセトリ - お歌一覧</title>
        <style>
            .wrapper { display: flex; }
            .main { flex: 1; position: sticky; top: 0px; align-self: baseline; }
            .aside { flex: 2; }
            .artist { font-size: small; }
            .movieName { font-size: small; }
        </style>
    </head>
    <body>
        <th:block th:insert="layout::header" />
        <div class="wrapper">
            <div class="main">
                <main>
                    <center>
                        <div id="player"></div>
                        <br>
                        <input type="checkbox" id="looping" onclick="onLoopFuncChanged()">
                        ループ再生
                    </center>
                </main>
            </div>
            <div class="aside">
                <aside>
                    <center>
                        <table border="1" id="songTbl">
                            <thead>
                            <tr>
                                <th>
                                    <div class="songName">Song Name</div>
                                    <div class="artist">Original Artist</div>
                                    <div class="movieName">Movie Name</div>
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="song: ${songs}">
                                <td>
                                    <a th:href="'javascript: transPage(\'' + ${song.movieId} + '\',' + ${song.time} + ');'"
                                       th:text="${song.songName}"
                                       class="songName"></a><br>
                                    <div th:text="${song.writer}" class="artist"></div>
                                    <div th:text="${song.movie.name}" class="movieName"></div>
                                </td>
                                <td th:text="${song.movieId}" style="display:none" class="movieId"></td>
                                <td th:text="${song.time}" style="display:none" class="time"></td>
                                <td th:text="${song.endTime}" style="display:none" class="endTime"></td>
                            </tr>
                            </tbody>
                        </table>
                    </center>
                </aside>
            </div>
        </div>
        <script th:inline="javascript">
            /*<![CDATA[*/
            let tag = document.createElement('script');
            tag.src = "https://www.youtube.com/player_api";
            let firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            let currentMovieId = /*[[${id}]]*/ 'null';

            let songInfo = [];

            /* 歌情報一覧読み込み */
            var rows = document.getElementById('songTbl').rows;
            [#th:block th:if="!${songs.isEmpty()}"]
            for (let i = 1; i < rows.length; i++) {
                songInfo.push({
                    movieId: rows[i].getElementsByClassName('movieId')[0].innerText,
                    time: parseInt(rows[i].getElementsByClassName('time')[0].innerText, 10),
                    endTime: parseInt(rows[i].getElementsByClassName('endTime')[0].innerText, 10)
                });
            }
            [/th:block]

            /* プレーヤー制御 */
            var player;
            function onYouTubePlayerAPIReady() {
                player = new YT.Player('player', {
                    height: '315',
                    width: '560',
                    videoId: /*[[${id}]]*/ 'null',
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange,
                        'onPlaybackRateChange': onPlaybackRateChange
                    }
                });
            }

            function jumpTo(movieId, time) {
                if (movieId != currentMovieId) {
                    player.loadVideoById(movieId, time);
                    currentMovieId = movieId;
                } else {
                    player.seekTo(time, true);
                    player.playVideo();

                    if (document.getElementById('looping').checked) {
                        setLooping();
                    }
                }
            }

            function transPage(movieId, time) {
                history.pushState(null, null, '?id=' + movieId + '&time=' + time);
                jumpTo(movieId, time);
            }

            window.onpopstate = function(event) {
                let params = location.search.substr(1).split('&');
                let movieId = "";
                let time = 0;

                for (let i = 0; i < params.length; i++) {
                    let kv = params[i].split('=');
                    if (kv.length != 2) {
                        break;
                    }
                    switch (kv[0]) {
                        case 'id':
                            movieId = kv[1];
                            break;
                        case 'time':
                            time = parseInt(kv[1]) || 0;
                            break;
                    }
                }
                jumpTo(movieId, time);
            }

            function onPlayerReady(event) {
                [#th:block th:if="${time != null}"]
                event.target.seekTo(/*[[${time}]]*/ 0, true);
                event.target.playVideo();
                [/th:block]
            }

            const eps = 0.5;

            let seekPollingIntervalId;
            let loopTimeoutId;

            let lastPollingTime = -1;
            let startTime = -1;
            let endTime = -1;

            function stopLooping() {
                window.clearInterval(seekPollingIntervalId);
                window.clearTimeout(loopTimeoutId);
                lastPollingTime = -1;
                startTime = -1;
                endTime = -1;
            }

            function loop() {
                if (startTime != -1) {
                    jumpTo(currentMovieId, startTime);
                    loopTimeoutId = window.setTimeout(loop, (endTime - startTime) * 1000 / player.getPlaybackRate());
                }
            }

            function setLooping() {
                stopLooping();

                let currentTime = player.getCurrentTime();

                for (let i = 0; i < songInfo.length; i++) {
                    if (currentMovieId == songInfo[i].movieId &&
                        songInfo[i].time <= currentTime &&
                        currentTime < songInfo[i].endTime) {
                        startTime = songInfo[i].time;
                        endTime = songInfo[i].endTime;

                        loopTimeoutId = window.setTimeout(loop, (endTime - currentTime) * 1000 / player.getPlaybackRate());
                        seekPollingIntervalId = window.setInterval(checkSeek, 1000);

                        break;
                    }
                }
            }

            function checkSeek() {
                let currentTime = player.getCurrentTime();
                if (lastPollingTime != -1) {
                    if (player.getPlayerState() == YT.PlayerState.PLAYING) {
                        if (Math.abs(currentTime - lastPollingTime - 1 * player.getPlaybackRate()) > eps) {
                            setLooping();
                            return;
                        }
                    }
                }
                lastPollingTime = currentTime;
            }

            function onPlayerStateChange(event) {
                if (document.getElementById('looping').checked) {
                    if (event.data == YT.PlayerState.PLAYING) {
                        setLooping();
                    } else {
                        stopLooping();
                    }
                }
            }

            function onLoopFuncChanged() {
                if (document.getElementById('looping').checked) {
                    if (player.getPlayerState() == YT.PlayerState.PLAYING) {
                        setLooping();
                    }
                } else {
                    stopLooping();
                }
            }

            function onPlaybackRateChange() {
                /* 再生速度変更はループ機能変更同様、ループ設定を変えるだけなのでonLoopFuncChangedに流す */
                onLoopFuncChanged();
            }

            /*]]>*/
        </script>
    </body>
</html>
